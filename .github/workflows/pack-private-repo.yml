name: Auto Pack Private Repo On Push

on:
  repository_dispatch:
    types: [pack_trigger]
  workflow_dispatch:

permissions:
  contents: write   # åˆ›å»º Release / Tag
  actions: read

jobs:
  pack-specific-repo:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # Step 1ï¼šæ‹‰å–ç§æœ‰ä»“åº“
      # -----------------------------
      - name: Clone Triggered Private Repository
        env:
          REPO_NAME: ${{ github.event.client_payload.repo_name }}
          REPO_BRANCH: ${{ github.event.client_payload.repo_branch }}
          GITHUB_USER: ${{ github.event.client_payload.github_user }}
          TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
        run: |
          set -e

          if [ -z "$REPO_NAME" ] || [ -z "$GITHUB_USER" ]; then
            echo "âŒ ç¼ºå°‘ repo_name æˆ– github_user"
            exit 1
          fi

          echo "ðŸ“¦ æ‹‰å–ç§æœ‰ä»“åº“: $GITHUB_USER/$REPO_NAME"
          REPO_URL="https://x-access-token:${TOKEN}@github.com/${GITHUB_USER}/${REPO_NAME}.git"

          git clone "$REPO_URL" target-repo
          cd target-repo
          git checkout "${REPO_BRANCH:-main}"

      # -----------------------------
      # Step 2ï¼šå®‰è£…ä¾èµ–ï¼ˆå¤šè¯­è¨€ï¼‰
      # -----------------------------
      - name: Setup Dependencies
        working-directory: ./target-repo
        run: |
          set -e

          if [ -f "package.json" ]; then
            echo "ðŸ”§ æ£€æµ‹åˆ° Node.js é¡¹ç›®"
          elif [ -f "pom.xml" ]; then
            echo "ðŸ”§ æ£€æµ‹åˆ° Maven é¡¹ç›®"
            sudo apt-get update
            sudo apt-get install -y maven
          elif [ -f "requirements.txt" ]; then
            echo "ðŸ”§ æ£€æµ‹åˆ° Python é¡¹ç›®"
            sudo apt-get update
            sudo apt-get install -y python3-pip
            pip3 install -r requirements.txt
            pip3 install pyinstaller
          else
            echo "âš  æœªè¯†åˆ«é¡¹ç›®ç±»åž‹ï¼Œè·³è¿‡ä¾èµ–å®‰è£…"
          fi

      - uses: actions/setup-node@v4
        if: hashFiles('target-repo/package.json') != ''
        with:
          node-version: 20

      - name: Install Node Dependencies
        if: hashFiles('target-repo/package.json') != ''
        working-directory: ./target-repo
        run: npm ci || npm install

      # -----------------------------
      # Step 3ï¼šæž„å»ºé¡¹ç›®
      # -----------------------------
      - name: Build Project
        working-directory: ./target-repo
        run: |
          set -e

          if [ -f "package.json" ]; then
            echo "ðŸš€ æž„å»º Node.js é¡¹ç›®"
            npm run build
          elif [ -f "pom.xml" ]; then
            echo "ðŸš€ æž„å»º Maven é¡¹ç›®"
            mvn package -DskipTests
          elif [ -f "requirements.txt" ]; then
            if [ -f "main.py" ]; then
              echo "ðŸš€ æž„å»º Python é¡¹ç›®"
              pyinstaller --onefile main.py
            else
              echo "âš  æœªæ‰¾åˆ° main.pyï¼Œè·³è¿‡ Python æž„å»º"
            fi
          else
            echo "âš  æ— æž„å»ºæ­¥éª¤"
          fi

      # -----------------------------
      # Step 4ï¼šæ”¶é›†æž„å»ºäº§ç‰©
      # -----------------------------
      - name: Collect Build Artifacts
        id: collect
        run: |
          set -e
          ARTIFACT_DIR="$GITHUB_WORKSPACE/build-artifacts"
          mkdir -p "$ARTIFACT_DIR"
          
          echo "ðŸ” æ­£åœ¨è‡ªåŠ¨æœå¯»æž„å»ºäº§ç‰©..."
          
          # 1. æ‰«æå¸¸è§æž„å»ºç›®å½• (dist, build, out, target, bin, release)
          # dist: Node.js, Python, etc.
          # target: Java (Maven), Rust
          # build: Web Frontends, Gradle
          # out: .NET, etc.
          for dir in dist target build out bin release; do
            if [ -d "./target-repo/$dir" ]; then
              echo "âœ… å‘çŽ°äº§ç‰©ç›®å½•: $dir"
              cp -r "./target-repo/$dir" "$ARTIFACT_DIR/"
            fi
          done
          
          # 2. æ‰«ææ ¹ç›®å½•ä¸‹çš„å¸¸è§äº§ç‰©æ–‡ä»¶ (.jar, .exe, .zip, .apk, .dmg, .whl)
          find ./target-repo -maxdepth 1 -type f \( -name "*.jar" -o -name "*.exe" -o -name "*.zip" -o -name "*.apk" -o -name "*.dmg" -o -name "*.whl" \) -exec cp {} "$ARTIFACT_DIR/" \;
          
          # 3. æ£€æŸ¥ç»“æžœ
          if [ "$(ls -A "$ARTIFACT_DIR")" ]; then
            echo "has_artifacts=true" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ å·²æ”¶é›†äº§ç‰©æ¸…å•:"
            ls -R "$ARTIFACT_DIR"
          else
            echo "has_artifacts=false" >> $GITHUB_OUTPUT
            echo "âŒ æœªèƒ½è‡ªåŠ¨è¯†åˆ«åˆ°äº§ç‰©ã€‚å½“å‰ç›®å½•ç»“æž„å¦‚ä¸‹ï¼š"
            # æ‰“å°ç›®å½•ç»“æž„è¾…åŠ©æŽ’æŸ¥ï¼ˆæŽ’é™¤ .git å’Œ node_modulesï¼‰
            find ./target-repo -maxdepth 2 -not -path '*/.*' -not -path '*/node_modules*'
          fi

      - name: Ensure Artifacts Exist
        if: steps.collect.outputs.has_artifacts != 'true'
        run: |
          echo "::error::æœªæ‰¾åˆ°æž„å»ºäº§ç‰©ï¼è¯·æ£€æŸ¥ build å‘½ä»¤æ˜¯å¦æˆåŠŸæ‰§è¡Œï¼Œæˆ–äº§ç‰©æ˜¯å¦åœ¨ dist/target/build ç­‰éžå¸¸è§„ç›®å½•ä¹‹å¤–ã€‚"
          exit 1

      # -----------------------------
      # Step 5ï¼šä¸Šä¼  Artifact
      # -----------------------------
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        if: steps.collect.outputs.has_artifacts == 'true'
        with:
          name: ${{ github.event.client_payload.repo_name }}-build
          path: build-artifacts/
          retention-days: 7

      # -----------------------------
      # Step 6ï¼šç”Ÿæˆ Release Tag
      # -----------------------------
      - name: Generate Release Tag
        id: tag
        run: |
          TS=$(date +'%Y%m%d-%H%M%S')-${GITHUB_RUN_NUMBER}
          NAME="${{ github.event.client_payload.repo_name }}"
          [ -z "$NAME" ] && NAME="manual-build"
          echo "tag_name=${NAME}-${TS}" >> $GITHUB_OUTPUT

      # -----------------------------
      # Step 7ï¼šåˆ›å»º Release
      # -----------------------------
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: steps.collect.outputs.has_artifacts == 'true'
        with:
          tag_name: ${{ steps.tag.outputs.tag_name }}
          name: Release ${{ steps.tag.outputs.tag_name }}
          body: |
            Source Repo: ${{ github.event.client_payload.github_user }}/${{ github.event.client_payload.repo_name }}
            Branch: ${{ github.event.client_payload.repo_branch }}
          files: build-artifacts/**
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
