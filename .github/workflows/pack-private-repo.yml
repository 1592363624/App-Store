name: App Store Release

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      # 1ï¸âƒ£ æ‹‰å–ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ å®‰è£… .NET
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      # 3ï¸âƒ£ è‡ªåŠ¨æŸ¥æ‰¾è§£å†³æ–¹æ¡ˆ
      - name: Detect solution file
        id: sln
        shell: pwsh
        run: |
          $sln = Get-ChildItem -Path . -Filter *.sln -Recurse | Select-Object -First 1
          if (-not $sln) {
            Write-Error "âŒ æœªæ‰¾åˆ° .sln æ–‡ä»¶"
            exit 1
          }
          Write-Host "âœ… ä½¿ç”¨è§£å†³æ–¹æ¡ˆ: $($sln.FullName)"
          echo "sln=$($sln.FullName)" >> $env:GITHUB_OUTPUT

      # 4ï¸âƒ£ ç”ŸæˆåŒ—äº¬æ—¶é—´
      - name: Generate Beijing Time
        id: time
        shell: pwsh
        run: |
          $time = (Get-Date).ToUniversalTime().AddHours(8).ToString("yyyyMMdd-HHmmss")
          echo "time=$time" >> $env:GITHUB_OUTPUT

      # 5ï¸âƒ£ Restoreï¼ˆä¸å…³å¿ƒ sln åå­—ï¼‰
      - name: Restore
        run: dotnet restore "${{ steps.sln.outputs.sln }}"

      # 6ï¸âƒ£ Buildï¼ˆä¸€æ¬¡æ„å»ºæ•´ä¸ªè§£å†³æ–¹æ¡ˆï¼‰
      - name: Build Solution
        run: dotnet build "${{ steps.sln.outputs.sln }}" -c Release --no-restore

      # 7ï¸âƒ£ å‘å¸ƒæ‰€æœ‰ exe é¡¹ç›®ï¼ˆè‡ªåŠ¨å‘ç°ï¼‰
      - name: Publish exe projects
        shell: pwsh
        run: |
          $projects = Get-ChildItem -Recurse -Filter *.csproj |
            Where-Object {
              Select-String "<OutputType>WinExe</OutputType>|<OutputType>Exe</OutputType>" $_
            }

          if (-not $projects) {
            Write-Error "âŒ æœªæ‰¾åˆ°å¯å‘å¸ƒçš„ exe é¡¹ç›®"
            exit 1
          }

          foreach ($proj in $projects) {
            $name = [System.IO.Path]::GetFileNameWithoutExtension($proj.FullName)
            Write-Host "ğŸš€ å‘å¸ƒé¡¹ç›®: $name"

            dotnet publish $proj.FullName `
              -c Release `
              -r win-x64 `
              --self-contained false `
              -o publish\$name
          }

      # 8ï¸âƒ£ æŒ‰ã€Œé¡¹ç›®å + åŒ—äº¬æ—¶é—´ã€æ‰“åŒ…
      - name: Zip artifacts
        shell: pwsh
        run: |
          $time = "${{ steps.time.outputs.time }}"
          New-Item -ItemType Directory -Force -Path dist | Out-Null

          Get-ChildItem publish -Directory | ForEach-Object {
            $zip = "$($_.Name)-$time.zip"
            Compress-Archive `
              -Path "$($_.FullName)\*" `
              -DestinationPath "dist\$zip"
          }

      # 9ï¸âƒ£ åˆ›å»º Release
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: AppStore-${{ steps.time.outputs.time }}
          name: AppStore-${{ steps.time.outputs.time }} (UTC+8)
          body: |
            ğŸš€ è‡ªåŠ¨æ„å»ºå‘å¸ƒ

            æ„å»ºæ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰ï¼š${{ steps.time.outputs.time }}

            æœ¬æ¬¡åŒ…å«é¡¹ç›®ï¼š
            - è‡ªåŠ¨ä»è§£å†³æ–¹æ¡ˆæ£€æµ‹
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ğŸ”Ÿ ä¸Šä¼  zip
      - name: Upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: AppStore-${{ steps.time.outputs.time }}
          files: dist/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
