name: App Store Auto Pack

on:
  repository_dispatch:
    types: [pack_trigger]
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  app-store-pack:
    runs-on: windows-latest

    env:
      ARTIFACT_ROOT: build-artifacts

    steps:
      # =====================================================
      # Step 1ï¼šæ‹‰å–ç§æœ‰æºä»“åº“
      # =====================================================
      - name: Clone source repository
        shell: bash
        run: |
          set -e

          REPO="${{ github.event.client_payload.repo_name }}"
          USER="${{ github.event.client_payload.github_user }}"
          BRANCH="${{ github.event.client_payload.repo_branch || 'main' }}"

          if [ -z "$REPO" ] || [ -z "$USER" ]; then
            echo "âŒ ç¼ºå°‘ repo_name æˆ– github_user"
            exit 1
          fi

          echo "ðŸ“¦ å…‹éš† $USER/$REPO ($BRANCH)"

          git clone --branch "$BRANCH" \
            "https://x-access-token:${{ secrets.PRIVATE_REPO_TOKEN }}@github.com/$USER/$REPO.git" \
            source

      # =====================================================
      # Step 2ï¼šçŽ¯å¢ƒå‡†å¤‡ï¼ˆæŒ‰éœ€ï¼‰
      # =====================================================
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Python
        shell: bash
        run: |
          pip install --upgrade pip
          pip install pyinstaller

      # =====================================================
      # Step 3ï¼šæ™ºèƒ½è¯†åˆ« + æž„å»º
      # =====================================================
      - name: Detect & Build
        shell: bash
        working-directory: ./source
        run: |
          set -e

          mkdir -p "../$ARTIFACT_ROOT"

          # -----------------------------
          # 1ï¸âƒ£ WPF / .NETï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
          # -----------------------------
          PROJECT=$(find . -name "*.csproj" | head -n 1 || true)

          if [ -n "$PROJECT" ]; then
            echo "ðŸŸ¦ æ£€æµ‹åˆ° .NET / WPF é¡¹ç›®ï¼š$PROJECT"

            dotnet restore "$PROJECT"
            dotnet publish "$PROJECT" \
              -c Release \
              -r win-x64 \
              --self-contained true \
              -p:PublishSingleFile=true \
              -p:EnableCompressionInSingleFile=true \
              -o "../$ARTIFACT_ROOT"

            exit 0
          fi

          # -----------------------------
          # 2ï¸âƒ£ Node.js
          # -----------------------------
          if [ -f "package.json" ]; then
            echo "ðŸŸ© æ£€æµ‹åˆ° Node.js é¡¹ç›®"

            npm ci || npm install
            npm run build

            [ -d "dist" ] && cp -r dist "../$ARTIFACT_ROOT/"
            exit 0
          fi

          # -----------------------------
          # 3ï¸âƒ£ Python
          # -----------------------------
          if [ -f "requirements.txt" ] || [ -f "pyproject.toml" ]; then
            echo "ðŸŸ¨ æ£€æµ‹åˆ° Python é¡¹ç›®"

            if [ ! -f "main.py" ]; then
              echo "âŒ Python é¡¹ç›®æœªæ‰¾åˆ° main.py"
              exit 1
            fi

            pyinstaller --onefile main.py
            cp dist/* "../$ARTIFACT_ROOT/"
            exit 0
          fi

          # -----------------------------
          # 4ï¸âƒ£ å…œåº•ï¼šæºç æ‰“åŒ…
          # -----------------------------
          echo "âš  æœªè¯†åˆ«æž„å»ºç±»åž‹ï¼Œæ‰“åŒ…æºç "
          cp -r . "../$ARTIFACT_ROOT/source"

      # =====================================================
      # Step 4ï¼šæ ¡éªŒäº§ç‰©
      # =====================================================
      - name: Verify artifacts
        shell: bash
        run: |
          if [ ! -d "$ARTIFACT_ROOT" ] || [ -z "$(ls -A "$ARTIFACT_ROOT")" ]; then
            echo "âŒ æœªç”Ÿæˆä»»ä½•æž„å»ºäº§ç‰©"
            exit 1
          fi

          echo "ðŸ“¦ æž„å»ºäº§ç‰©æ¸…å•ï¼š"
          ls -R "$ARTIFACT_ROOT"

      # =====================================================
      # Step 5ï¼šä¸Šä¼  Artifact
      # =====================================================
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.client_payload.repo_name }}-build
          path: build-artifacts/
          retention-days: 7

      # =====================================================
      # Step 6ï¼šRelease
      # =====================================================
      - name: Generate tag
        id: tag
        shell: bash
        run: |
          NAME="${{ github.event.client_payload.repo_name }}"
          TS=$(date +'%Y%m%d-%H%M%S')-${GITHUB_RUN_NUMBER}
          echo "tag=${NAME}-${TS}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: App Store Release ${{ steps.tag.outputs.tag }}
          body: |
            Source Repo: ${{ github.event.client_payload.github_user }}/${{ github.event.client_payload.repo_name }}
            Branch: ${{ github.event.client_payload.repo_branch }}
          files: build-artifacts/**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
