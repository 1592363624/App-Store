name: App Store Multi-App Pack

on:
  repository_dispatch:
    types: [pack_trigger]
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  build-and-pack:
    runs-on: windows-latest

    env:
      PUBLISH_ROOT: publish
      ZIP_ROOT: release-zips

    steps:
      # =====================================================
      # Step 1ï¼šé…ç½® Git å‡­è¯ï¼ˆæ‹‰ç§æœ‰ä»“åº“ï¼‰
      # =====================================================
      - name: Configure Git Credentials
        shell: bash
        run: |
          git config --global credential.helper store
          echo "https://${{ secrets.PRIVATE_REPO_TOKEN }}:@github.com" > ~/.git-credentials

      # =====================================================
      # Step 2ï¼šæ‹‰å–æºä»“åº“
      # =====================================================
      - name: Clone Source Repository
        shell: bash
        env:
          REPO_NAME: ${{ github.event.client_payload.repo_name }}
          REPO_BRANCH: ${{ github.event.client_payload.repo_branch }}
          GITHUB_USER: ${{ github.event.client_payload.github_user }}
        run: |
          set -e

          if [ -z "$REPO_NAME" ] || [ -z "$GITHUB_USER" ]; then
            echo "âŒ ç¼ºå°‘ repo_name / github_user"
            exit 1
          fi

          git clone https://github.com/$GITHUB_USER/$REPO_NAME.git source
          cd source
          git checkout ${REPO_BRANCH:-main}

      # =====================================================
      # Step 3ï¼šå®‰è£… .NET SDKï¼ˆWindows Runner é»˜è®¤æœ‰ï¼Œä½†æ˜¾å¼æ›´ç¨³ï¼‰
      # =====================================================
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      # =====================================================
      # Step 4ï¼šä¸€æ¬¡æ€§æž„å»ºæ•´ä¸ªè§£å†³æ–¹æ¡ˆ
      # =====================================================
      - name: Publish Solution
        shell: pwsh
        working-directory: source
        run: |
          $sln = Get-ChildItem -Filter *.sln | Select-Object -First 1
          if (-not $sln) {
            Write-Error "âŒ æœªæ‰¾åˆ° .sln æ–‡ä»¶"
            exit 1
          }

          dotnet publish $sln `
            -c Release `
            -r win-x64 `
            --self-contained true `
            -p:PublishSingleFile=true `
            -o ../${{ env.PUBLISH_ROOT }}

      # =====================================================
      # Step 5ï¼šæŒ‰ exe æ‹†åˆ†ç›®å½•
      # =====================================================
      - name: Split Publish Output By Exe
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path $env:ZIP_ROOT | Out-Null

          Get-ChildItem $env:PUBLISH_ROOT -Filter *.exe | ForEach-Object {
            $appName = $_.BaseName
            $appDir = Join-Path $env:ZIP_ROOT $appName
            New-Item -ItemType Directory -Force -Path $appDir | Out-Null

            Write-Host "ðŸ“¦ å¤„ç†åº”ç”¨ï¼š$appName"

            Copy-Item "$env:PUBLISH_ROOT\*" $appDir -Recurse -Force
          }

      # =====================================================
      # Step 6ï¼šæ¯ä¸ª exe æ‰“ä¸€ä¸ª zip
      # =====================================================
      - name: Create Zip Packages
        shell: pwsh
        run: |
          Get-ChildItem $env:ZIP_ROOT -Directory | ForEach-Object {
            $zipName = "$($_.Name).zip"
            Compress-Archive -Path "$($_.FullName)\*" -DestinationPath $zipName -Force
            Write-Host "âœ… å·²ç”Ÿæˆ $zipName"
          }

      # =====================================================
      # Step 7ï¼šç”Ÿæˆ Release Tag
      # =====================================================
      - name: Generate Tag
        id: tag
        shell: bash
        run: |
          TS=$(date +'%Y%m%d-%H%M%S')-${GITHUB_RUN_NUMBER}
          echo "tag=AppStore-${TS}" >> $GITHUB_OUTPUT

      # =====================================================
      # Step 8ï¼šåˆ›å»º Releaseï¼ˆä¸€æ¬¡ï¼‰
      # =====================================================
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: App Store Release ${{ steps.tag.outputs.tag }}
          body: |
            Source Repo: ${{ github.event.client_payload.github_user }}/${{ github.event.client_payload.repo_name }}
            Branch: ${{ github.event.client_payload.repo_branch }}
          files: |
            *.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
